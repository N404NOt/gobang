<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆå¤§å…</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/game_hall.css">
    <audio autoplay="autoplay" loop="loop" controls="controls"><source src="music/å…°äº­é¸¡åº.mp3" type="audio/mp3"></audio>

    

</head>
<body>
    <div class="nav"> äº”ğŸ“æ£‹å¯¹æˆ˜</div>
    <!-- æ•´ä¸ªç•Œé¢çš„å®¹å™¨å…ƒç´  -->
    <div class="container">
    <!-- è¿™ä¸ªdiv åœ¨ containerä¸­å¤„äºæ°´å¹³å±…ä¸­è¿™æ ·çš„ä½ç½® -->
    <div>
        <!-- å±•ç¤ºç”¨æˆ·ä¿¡æ¯ -->
        <div id="screen"></div>
        <div id="match-button">å¼€å§‹åŒ¹é…</div>
</div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script>
        $.ajax({
            type:'get',
            url: '/userInfo',

            success: function(body) {
                let screenDiv = document.querySelector('#screen');
                screenDiv.innerHTML = 'ç©å®¶: ' + body.username + ' åˆ†æ•°: ' +
                body.score + '<br> æ¯”èµ›åœºæ¬¡: ' + body.totalCount + ' è·èƒœåœºæ¬¡: ' +
                body.winCount

        },
        error: function() {
            alert("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥");
        }
    });

    // æ­¤å¤„è¿›è¡Œåˆå§‹åŒ– websocket,å¹¶ä¸”å®ç°å‰ç«¯çš„åŒ¹é…é€»è¾‘
    let webSocketUrl = "ws://" + location.host + "/findMatch";
    let websocket = new WebSocket(webSocketUrl);
    websocket.onopen = function() {
        console.log("onopen");
    }
    websocket.onclose = function() {
        console.log("onclose");
    }
    websocket.onerror = function() {
        console.log("onerror");
    }
    // ç›‘å¬é¡µé¢å…³é—­äº‹ä»¶ï¼Œåœ¨é¡µé¢å…³é—­ä¹‹å‰ï¼Œæ‰‹åŠ¨è°ƒç”¨è¿™é‡Œçš„ websocket çš„ close æ–¹æ³•
    window.onbeforeunload = function() {
        websocket.close();
    }

    // è¦å¤„ç†æœåŠ¡å™¨è¿”å›çš„å“åº”
    websocket.onmessage = function(e) {
        // å¤„ç†æœåŠ¡å™¨è¿”å›çš„å“åº”æ•°æ®ï¼Œè¿™ä¸ªå“åº”é’ˆå¯¹â€œå¼€å§‹åŒ¹é…â€/"ç»“æŸåŒ¹é…"
        // JSONå¯¹è±¡è½¬æ¢æˆJSå¯¹è±¡ï¼Œ JSON.parse , JSå¯¹è±¡è½¬æˆJSONå­—ç¬¦ä¸² JSON.stringify
        let resp = JSON.parse(e.data);
        let matchButton = document.querySelector('#match-button');
        console.log("resp.message:  " + resp.message);
        if(!resp.ok) {
            console.log("æ¸¸æˆå¤§å…ä¸­æ¥æ”¶åˆ°äº†å¤±è´¥å“åº”ï¼" + resp.reason);
            return;
        }
        if(resp.message == 'startMatch') {
            // å¼€å§‹åŒ¹é…è¯·æ±‚å‘é€æˆåŠŸ
            console.log("è¿›å…¥åŒ¹é…é˜Ÿåˆ—æˆåŠŸï¼");
            matchButton.innerHTML = 'åŒ¹é…ä¸­...(ç‚¹å‡»åœæ­¢)'
        } else if(resp.message == 'stopMatch') {
            // ç»“æŸåŒ¹é…è¯·æ±‚å‘é€æˆåŠŸ
            console.log("ç¦»å¼€åŒ¹é…é˜Ÿåˆ—æˆåŠŸï¼");
            matchButton.innerHTML = 'å¼€å§‹åŒ¹é…';
        } else if(resp.message == 'matchSuccess') {
            // å·²ç»åŒ¹é…åˆ°å¯¹æ‰‹äº†
            console.log("åŒ¹é…åˆ°å¯¹æ‰‹ï¼è¿›å…¥æ¸¸æˆæˆ¿é—´");
            location.replace("/game_room.html")
        } else if (resp.message == 'repeatConnection') {
            alert('å½“å‰æ£€æµ‹åˆ°å¤šå¼€! è¯·ä½¿ç”¨å…¶ä»–è´¦å·ç™»å½•');
            location.replace("/login.html");
        } else {
            console.log("æ¥æ”¶åˆ°éæ³•å“åº”! message: " +e.message);
        }
    }

    let matchButton = document.querySelector('#match-button');
    matchButton.onclick = function() {
        // åœ¨è§¦å‘ websocket è¯·æ±‚ä¹‹å‰ï¼Œå…ˆç¡®è®¤ä¸‹ websocket è¿æ¥æ˜¯å¦æ­£å¸¸
        if(websocket.readyState == websocket.OPEN) {
            // å¦‚æœå½“å‰ä¸º OPEN çŠ¶æ€ï¼Œè¯´æ˜è¿æ¥æ­£å¸¸
            // è¿™é‡Œå‘é€çš„æ•°æ®å¯èƒ½ä¸¤ç§ï¼Œå¼€å§‹åŒ¹é…/åœæ­¢åŒ¹é…
            if(matchButton.innerHTML == 'å¼€å§‹åŒ¹é…') {
                console.log("å¼€å§‹åŒ¹é…");
                websocket.send(JSON.stringify({
                    message: 'startMatch',
                }));
            } else if (matchButton.innerHTML == 'åŒ¹é…ä¸­...(ç‚¹å‡»åœæ­¢)') {
                console.log("åœæ­¢åŒ¹é…");
                // JS å¯¹è±¡è½¬æˆJSONå­—ç¬¦ä¸²
                websocket.send(JSON.stringify({
                    message: 'stopMatch',
                }))
            }
        } else {
            // è¿™æ˜¯è¯´æ˜è¿æ¥å½“å‰å¼‚å¸¸
            alert("å½“å‰æ‚¨çš„è¿æ¥å·²ç»æ–­å¼€ï¼è¯·é‡æ–°ç™»å½•ï¼");
            location.assign('/login.html');
        }
    }



    </script>
    
</body>
</html>